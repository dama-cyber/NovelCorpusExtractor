# 完整写作系统整合文档

本文档说明如何将语料库提取、七步创作方法论和创作工具整合成一个完整的写作系统。

## 📋 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                    完整写作系统                              │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌──────────────────┐         ┌──────────────────┐         │
│  │  语料库提取流程  │─────────▶│  七步创作方法论  │         │
│  │                  │         │                  │         │
│  │ • Reader         │         │ • Constitution   │         │
│  │ • Analyst        │         │ • Specify        │         │
│  │ • Archivist      │         │ • Clarify        │         │
│  │ • Extractor      │         │ • Plan           │         │
│  │                  │         │ • Tasks          │         │
│  │ 输出:            │         │ • Write (缝合)   │         │
│  │ • 记忆体         │         │ • Analyze        │         │
│  │ • 语料库片段     │         │                  │         │
│  └──────────────────┘         └──────────────────┘         │
│           │                            │                    │
│           │                            │                    │
│           └────────────┬───────────────┘                    │
│                        │                                    │
│                        ▼                                    │
│              ┌──────────────────┐                          │
│              │   创作工具集成   │                          │
│              │                  │                          │
│              │ • 10大创作工具   │                          │
│              │ • 映射到各阶段   │                          │
│              └──────────────────┘                          │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

## 🔄 完整工作流程

### 阶段一：语料库提取（为写作提供素材）

**目标**：从优秀小说中提取高价值片段，构建可复用的语料库

**流程**：
1. **Reader** → 读取和分块小说文本
2. **Analyst** → 分析文本块，提取主题、情感、Hook评分
3. **Extractor** → 深度提取高价值片段（战斗、对话、环境描写等）
4. **Archivist** → 归档到记忆体和语料库
5. **Planner** → 生成剧情大纲和伏笔追踪

**输出**：
- **语料库片段**（`corpus_samples/*.txt`）- **用于后续缝合**

> **注意**：如果是从零开始创作（不使用拆书流程），世界观记忆体、人物记忆体、剧情大纲和伏笔追踪表会在七步创作方法论的相应阶段自动创建。

### 阶段二：七步创作方法论（从零开始创作）

#### 1. Constitution（建立创作原则）

**映射的创作工具**：
- ✅ **世界观冲突检测器**：验证世界观设定的一致性
- ✅ **角色一致性检查器**：确保角色设定规则清晰

**功能**：
- 定义不可妥协的写作原则
- 制定风格指南
- 确定核心价值观
- 建立世界观一致性规则
- 建立角色一致性规则

**输入**：项目初始信息
**输出**：创作原则文档

---

#### 2. Specify（定义故事需求）⭐ **自动创建世界观和人物记忆体**

**映射的创作工具**：
- ✅ **商业化优化器**：定义商业化目标和成功标准
- ✅ **平台适配器**：确定目标平台和适配要求

**功能**：
- 定义故事概述（一句话梗概）
- 确定目标受众和目标平台
- 定义故事类型和风格
- 确定核心冲突和主题
- 描述主要角色
- 选择故事结构
- 定义成功标准
- 规划商业化策略
- **自动提取并创建世界观记忆体**（`02_世界观记忆体.yaml`）
- **自动提取并创建人物记忆体**（`03_人物记忆体.yaml`）

**输入**：创作原则
**输出**：
- 故事需求规范（类似 PRD）
- 世界观记忆体文件
- 人物记忆体文件

---

#### 3. Clarify（关键澄清）

**映射的创作工具**：
- ✅ **Hook 优化器**：澄清开篇钩子和关键转折点
- ✅ **开篇场景生成器**：澄清开篇风格和节奏

**功能**：
- AI 识别规范中的歧义
- 生成最多 5 个关键问题
- 提供建议答案
- 澄清开篇策略
- 澄清关键情节转折

**输入**：故事需求规范
**输出**：澄清问题和答案

---

#### 4. Plan（创作计划）⭐ **自动创建剧情大纲和伏笔追踪表**

**映射的创作工具**：
- ✅ **情绪曲线优化器**：规划各章节的情绪节奏
- ✅ **伏笔提醒器**：规划伏笔的埋设和回收

**功能**：
- 规划章节结构（章节数量和大致内容）
- 设计角色弧线（主要角色的成长轨迹）
- 构建世界观（如果需要）
- 规划情节时间线（主要事件的时间顺序）
- 布局伏笔（关键伏笔的埋设和回收计划）
- 规划情绪曲线（各章节的情绪节奏，高潮和低谷的分布）
- 规划 Hook 点（每章的钩子和转折点）
- 制定语料库使用策略（哪些场景可以使用语料库片段进行缝合）
- **自动提取并创建剧情规划大纲**（`04_剧情规划大纲.yaml`）
- **自动提取并创建伏笔追踪表**（`05_伏笔追踪表.yaml`）

**输入**：澄清后的规范、世界观记忆体、人物记忆体
**输出**：
- 详细创作计划
- 剧情规划大纲文件
- 伏笔追踪表文件

---

#### 5. Tasks（任务分解）

**映射的创作工具**：
- ✅ **章节标题生成器**：为每个任务生成候选标题

**功能**：
- 将计划分解为可执行的写作任务
- 为每个任务设置优先级
- 定义任务依赖关系
- 估算工作量
- 定义验收标准
- 为每个章节任务生成 2-3 个候选标题
- 标注建议使用的语料库片段类型

**输入**：创作计划
**输出**：任务列表（JSON 格式）

---

#### 6. Write（执行写作）⭐ **核心缝合阶段**

**映射的创作工具**：
- ✅ **语料库缝合**：从语料库检索相关片段进行缝合
- ✅ **AI 检测规避器**：优化生成的文本，降低 AI 检测风险

**功能**：
- 根据任务描述从语料库检索相关片段
- 使用 LLM 将语料库片段适配到当前任务
- 替换专有名词为当前故事中的角色和地点
- 保持情节逻辑连贯
- 确保风格与整体作品一致
- 使用 AI 检测规避器优化文本

**工作流程**：
```
任务描述
    ↓
从语料库检索相关片段（top_k=3）
    ↓
构建包含语料库片段的提示词
    ↓
LLM 生成适配后的文本
    ↓
AI 检测规避器优化
    ↓
输出最终文本
```

**输入**：
- 任务描述
- 项目上下文（创作原则、规范、计划等）
- 语料库片段（自动检索）

**输出**：
- 生成的文本内容
- 使用的语料库片段 ID
- 缝合统计信息

**示例**：
```python
# 任务：写第一章开篇场景
# 系统自动从语料库检索：
# - 片段1：重生文开篇（模板化）
# - 片段2：系统激活场景
# - 片段3：打脸爽文开篇

# LLM 将片段适配到当前故事：
# - 替换角色名
# - 替换地点名
# - 调整情节逻辑
# - 保持风格一致

# 输出：适配后的第一章内容
```

---

#### 7. Analyze（全面验证）

**映射的创作工具**：
- ✅ **角色一致性检查器**：验证角色行为一致性
- ✅ **世界观冲突检测器**：检测世界观设定冲突
- ✅ **伏笔提醒器**：检查伏笔埋设和回收
- ✅ **AI 检测规避器**：评估 AI 检测风险
- ✅ **情绪曲线优化器**：验证情绪节奏
- ✅ **结尾优化器**：如果接近结尾，优化结尾

**功能**：
- 验证情节一致性
- 验证时间线准确性
- 检查角色发展（使用角色一致性检查器）
- 验证创作原则遵循
- 检查规范符合度
- 检查伏笔处理（使用伏笔提醒器）
- 验证风格一致性
- 检查世界观一致性（使用世界观冲突检测器）
- 评估 AI 检测风险（使用 AI 检测规避器）

**输入**：所有已写内容
**输出**：
- 质量分析报告
- 问题列表（带严重程度和修复建议）
- 创作工具检测结果

---

## 🛠️ 创作工具完整映射表

| 七步阶段 | 映射的创作工具 | 作用 |
|---------|--------------|------|
| **Constitution** | 世界观冲突检测器<br>角色一致性检查器 | 建立一致性规则 |
| **Specify** | 商业化优化器<br>平台适配器 | 定义商业化目标和平台要求 |
| **Clarify** | Hook 优化器<br>开篇场景生成器 | 澄清关键情节点 |
| **Plan** | 情绪曲线优化器<br>伏笔提醒器 | 规划节奏和伏笔 |
| **Tasks** | 章节标题生成器 | 生成任务标题 |
| **Write** | **语料库缝合**<br>AI 检测规避器 | **核心缝合功能** |
| **Analyze** | 角色一致性检查器<br>世界观冲突检测器<br>伏笔提醒器<br>AI 检测规避器<br>情绪曲线优化器<br>结尾优化器 | 全面质量验证 |

## 📚 语料库缝合机制

### 缝合流程

1. **任务分析**
   - 解析任务描述
   - 提取关键词（场景类型、情节类型等）
   - 确定小说类型

2. **片段检索**
   ```python
   fragments = frankentexts_manager.search_fragments(
       query=task_description,
       genre=novel_type,
       top_k=3
   )
   ```

3. **片段适配**
   - LLM 根据任务上下文适配片段
   - 替换专有名词
   - 调整情节逻辑
   - 保持风格一致

4. **文本生成**
   - 使用适配后的片段作为参考
   - 生成符合任务要求的文本

5. **后处理**
   - AI 检测规避
   - 风格统一
   - 逻辑检查

### 语料库片段类型

语料库中的片段按类型分类：
- **场景类型**：战斗场景、对话场景、环境描写、心理描写等
- **情节类型**：开篇、转折、高潮、结尾等
- **小说类型**：玄幻、言情、悬疑等 36+ 种类型

### 模板化处理

语料库片段经过模板化处理：
- 专有名词替换为占位符（如 `{主角名}`、`{地点名}`）
- 保留结构和风格
- 便于适配到不同故事

## 🔗 系统整合点

### 1. 语料库 → 七步方法论

**整合点**：Write 阶段
- 从语料库检索相关片段
- 使用片段进行文本缝合
- 记录使用的片段 ID

### 2. 七步方法论 → 创作工具

**整合点**：各阶段
- Constitution：使用检测工具建立规则
- Specify：使用优化工具定义目标
- Clarify：使用生成工具澄清要点
- Plan：使用规划工具制定计划
- Tasks：使用生成工具创建任务
- Write：使用缝合工具生成文本
- Analyze：使用检测工具验证质量

### 3. 记忆体 → 创作工具

**整合点**：各阶段
- 世界观记忆体 → 世界观冲突检测器
- 人物记忆体 → 角色一致性检查器
- 伏笔追踪表 → 伏笔提醒器

## 📖 使用示例

### 完整流程示例

```python
from core.workflows import WorkflowFactory
from core.frankentexts import FrankentextsManager
from core.creative_workflow import CreativeWorkflowPipeline

# 1. 初始化
frankentexts_manager = FrankentextsManager("corpus_samples")
workflow = WorkflowFactory.create_workflow(
    "seven_step",
    project_id="my_novel",
    card_manager=card_manager,
    project_manager=project_manager,
    llm_client=llm_client
)

# 2. 设置语料库管理器
workflow.frankentexts_manager = frankentexts_manager

# 3. 设置创作工具
creative_pipeline = CreativeWorkflowPipeline(memory_manager)
workflow.character_checker = creative_pipeline.character_checker
workflow.worldview_detector = creative_pipeline.worldview_detector
workflow.ai_evader = creative_pipeline.ai_evader
workflow.foreshadowing_reminder = creative_pipeline.foreshadowing_reminder

# 4. 执行七步流程
# Constitution
constitution = await workflow.expand_stage(
    workflow.get_stages()[0],  # Constitution stage
    parent_card_id=None
)

# Specify
specification = await workflow.expand_stage(
    workflow.get_stages()[1],  # Specify stage
    parent_card_id=constitution['card_id']
)

# ... 继续其他阶段

# Write（自动使用语料库缝合）
writing_result = await workflow.expand_stage(
    workflow.get_stages()[5],  # Write stage
    parent_card_id=tasks['card_id']
)

print(f"使用了 {writing_result['corpus_fragment_count']} 个语料库片段")
print(f"片段ID: {writing_result['used_corpus_fragments']}")

# Analyze（使用所有检测工具）
analysis = await workflow.expand_stage(
    workflow.get_stages()[6],  # Analyze stage
    parent_card_id=writing_result['card_id']
)

print(f"发现 {len(analysis['issues'])} 个问题")
print(f"质量检查结果: {analysis['quality_checks']}")
```

## 🎯 关键优势

1. **完整的创作闭环**
   - 从语料提取到文本生成
   - 从规划到验证
   - 全流程自动化

2. **智能缝合机制**
   - 自动检索相关片段
   - 智能适配到当前故事
   - 保持风格一致性

3. **质量保证**
   - 多工具协同检测
   - 早期发现问题
   - 自动化修复建议

4. **可扩展性**
   - 语料库持续积累
   - 工具模块化设计
   - 易于添加新功能

## 📝 总结

通过整合语料库提取、七步创作方法论和创作工具，我们构建了一个完整的写作系统：

- **语料库**：提供高质量的写作素材
- **七步方法论**：提供结构化的创作流程
- **创作工具**：提供专业的创作辅助
- **缝合机制**：将语料库片段智能适配到新故事

这个系统实现了从"提取优秀片段"到"生成新作品"的完整闭环，大大提高了创作效率和质量。

---

**最后更新**: 2025-01-XX
**版本**: 1.0.0

